<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Porting Rails Plugins to DataMapper - set_trace_func</title>

<!-- Meta -->
<meta name="description" content="Just a random coder writing about technology, web development, and various other geeky topics." />
<meta name="author" content="Jamie Macey">
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/index.xml" />

<!-- Favicons -->
<!-- 
<link rel="apple-touch-icon" href="/docs/5.2/assets/img/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/docs/5.2/assets/img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/docs/5.2/assets/img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/docs/5.2/assets/img/favicons/manifest.json">
<link rel="mask-icon" href="/docs/5.2/assets/img/favicons/safari-pinned-tab.svg" color="#712cf9">
<link rel="icon" href="/docs/5.2/assets/img/favicons/favicon.ico">
-->

<!-- Style -->
<link rel="stylesheet" href="/_bridgetown/static/index.J6BIDSPS.css" />

<!-- Script -->
<!-- <script src="/_bridgetown/static/index.PJZZ2K4I.js" defer></script> -->


    <link type="application/atom+xml" rel="alternate" href="https://blog.tracefunc.com/index.xml" title="set_trace_func" />
  </head>
  <body class="post ">
    <header>
  <nav>
    <ul>
      <li><h1><a href="/">set_trace_func</a></h1></li>
      <!-- The following float right, and are defined right-to-left -->
      <li class="float-right"><a href="/notes/">Notes</a></li>
      <li class="float-right"><a href="/projects/">Projects</a></li>
      <li class="float-right"><a href="/tags/">Tags</a></li>
      <li class="float-right"><a href="/archive/">Archive</a></li>
    </ul>
  </nav>
</header>


    <main>
      <aside>


<div>
  <h4>About</h4>
  <picture class="float-end w-50 rounded-circle">
    <source srcset="/assets/memoji.webp" type="image/webp">
    <source srcset="/assets/memoji.jpeg" type="image/jpeg">
    <img src="/assets/memoji.png" alt="Avatar of Author" loading="lazy" class="w-100">
  </picture>

  <p>Jamie Macey is a senior software engineer with over 15 years experience
            in the Ruby and Rails ecosystems, largely on the back-end.</p>
  <p class="mb-0">Husband, father, gamer, and all-around geek. Ask about my latest
            3d print, or toy software project.</p>
</div>

<div>
  <h4>Elsewhere</h4>
  <ol class="list-unstyled">
    <li>
      <a href="https://github.com/jamie/"">GitHub</a>
    </li>
    <li style="display: none;">
      <a rel="me" href="https://ruby.social/@jamie_ca">Mastodon</a>
    </li>
    <li>
      <a href="/static/jamie-macey/">Resume</a>
    </li>
    <li>
      <a href="https://www.linkedin.com/in/jamiemacey/">Linkedin</a>
    </li>
    <li>
      <a href="mailto:jamie.blog@tracefunc.com">Contact</a>
    </li>
  </ol>
</div>
</aside>

      <section>
  <article>
  <h2><a href="/2008/07/15/porting-rails-plugins-to-datamapper-html/">Porting Rails Plugins to DataMapper</a></h2>
  <blockquote>
    15th Jul 2008
    
      | Tags:
      <a href="/tags/#rails">rails</a> <a href="/tags/#merb">merb</a> <a href="/tags/#datamapper">datamapper</a> 
    
  </blockquote>

  
    <p>As a follow-up to my <a href="http://blog.tracefunc.com/2008/07/15/porting-rails-plugins-to-merb">previous post</a>, here’s some gotchas to be aware of if you’re looking to support both ActiveRecord and DataMapper in a Merb (and/or Rails) plugin.</p>

<h2 id="the-strategy">The Strategy</h2>

<p>The best way I’ve found to handle multiple ORM support in your plugin is not to start monkeypatching around to make one ORM handle like another.  I’ve done it, and can tell you that wrapping one ORM’s backend into another is <a href="http://pastie.org/233178">ugly</a>.</p>

<p>The better way is to localize the points where your plugin interacts with the data model, with an eye to swapping them out.  For the above example, I would be better off taking the method that <em>used</em> the reflection method and putting it inside an ActiveRecord-specific module.  Then, create a DataMapper-specific module that defines the same method, but instead relies on the DM backend to get at the association information.  Finally, when the plugin was loaded I could just include one of the modules based on which ORM was loaded into the runtime.</p>

<h2 id="basic-translation">Basic Translation</h2>

<p>Now that we have a plan, we can start translating our extracted functions from AR bits to DM bits.  There’s a bunch of fairly straightforward transformations we can make.</p>

<p>It’s unfortunate that there isn’t more unity between the two, as from a library-developer’s perspective it would make this sort of thing much easier, but the DM team is pretty vocal about wanting the best API they can get, and not worrying about being hobbled by how AR does things.  I don’t particularly disagree.</p>

<table>
  <tr><td>ActiveRecord</td><td>DataMapper</td></tr>
  <tr><td>.find(:all, ...)   </td><td>.all(...)         </td></tr>
  <tr><td>.find(:first, ...) </td><td>.first(...)       </td></tr>
  <tr><td>.find(id)          </td><td>.get(...)         </td></tr>
  <tr><td>.find_all_by_id(id)</td><td>.all(:id =&gt; ids)  </td></tr>
  <tr><td>.table_name        </td><td>.storage_name     </td></tr>
  <tr><td>.primary_key       </td><td>.key.first.name   </td></tr>
  <tr><td>.connection        </td><td>repository.adapter</td></tr>

  <tr><td></td><td></td></tr>
</table>

<h2 id="raw-sql">Raw SQL</h2>

<p>If you’re running raw SQL queries, firstly, I’m sorry.  Secondly, you want to run <code class="highlighter-rouge">.query</code> instead of <code class="highlighter-rouge">.execute</code>.  Thirdly, if you care about getting the results of the query back, AR returns an array of arrays, DM returns an array of hashlike objects, so you want to map them for their values array.  The hashlike object in question is order-preserving, so you’ll get things out in the right order.  If you’re concerned, grab one of the result objects and verify that the keys array is in the correct order.</p>

<h2 id="hooks">Hooks</h2>

<p>ActiveRecord defines a few hook points, along the lines of <code class="highlighter-rouge">before_create</code> and <code class="highlighter-rouge">after_save</code>.  DataMapper uses (a modified version of) the Extlib gem, allowing it to hook pretty much any method.  The syntax is like <code class="highlighter-rouge">before(:create)</code> and <code class="highlighter-rouge">after(:save)</code>.  AR’s hooks pass in the object to work with, DM’s have the object available as <code class="highlighter-rouge">self</code>.</p>

<p>In before hooks, the AR hook chain stops if your method returns false, in DM you must <code class="highlighter-rouge">throw :halt</code>.</p>

<h2 id="things-you-shouldnt-be-doing-anyways">Things You Shouldn’t Be Doing Anyways</h2>

<p>If you’re manually setting <code class="highlighter-rouge">@attribute</code> values in your AR code, you’ll need to use <code class="highlighter-rouge">instance_variable_set</code> for DataMapper.  I recommend writing manual accessor methods to wrap it for abstraction.</p>

<p>If you’re wanting some arbitrary data structures back, I recommend using OpenStruct (<code class="highlighter-rouge">require 'ostruct'</code>) to pass structured data back and forth.  This was especially handy when I wanted some results from DM to look like AR, because I was just doing an adapter (bad me!) and the client code wanted to interact with the AR object.  Just be aware that OpenStruct doesn’t quite clear out all its methods, so you might want to define some custom readers anyway.  I had problems with <code class="highlighter-rouge">type</code> in particular, which is a deprecated alias of <code class="highlighter-rouge">class</code> - redefining the method to return <code class="highlighter-rouge">@table[:type]</code> fixed that up nicely.</p>


  
</article>

</section>

<nav aria-label="Pagination">
  <ul>
    
    <li>
      <a href="/2008/07/14/two-questions-html/">
        &laquo; Two Questions
      </a>
    </li>
    
    
    <li class="float-right">
      <a href="/2008/07/15/porting-rails-plugins-to-merb-html/">
        Porting Rails Plugins to Merb &raquo;
      </a>
    </li>
    
  </ul>
</nav>

    </main>

    <footer>
  <p>Styled with <a href="https://classless.de/">Classless.css</a>.</p>
</footer>


    <script data-goatcounter="https://tracefunc.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </body>

</html>

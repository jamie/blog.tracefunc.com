<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>set_trace_func - Async-Observer with RabbitMQ</title>
    <meta content='text/html; charset=utf-8' http-equiv='content-type' />
    <link rel="stylesheet" href="/css/blueprint.css" type="text/css"/>
    <!--[if IE]>
      <link rel="stylesheet" href="/css/blueprint-ie.css" type="text/css"/>
    <![endif]-->
    <link rel="stylesheet" href="/css/master.css" type="text/css"/>
    <link href='http://feeds.feedburner.com/set_trace_func' rel='alternate' type='application/atom+xml' />

    <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
    <script type='text/javascript' src="/js/prettify.js"></script>
    <script type='text/javascript' src="/js/blog.js"></script>
  </head>
  <body>
    <div class='container'>
      <div class='span-20 last' id='header'>

        <h1>
          <a href='/'>set_trace_func</a>
        </h1>
        <h2>veni, vidi, didici</h2>
      </div>
      <div class='span-20 last' id='menu'>
        <div id='feedburner'>
          <a href='http://feeds.feedburner.com/set_trace_func'><img alt='RSS Feed' src='http://feeds.feedburner.com/~fc/set_trace_func?bg=0099ff&amp;fg=000000&amp;anim=0' /></a>
        </div>
        <ul style='float: right;'>
          <li><a>&#8203;</a></li>
          <li><a href='/about/'>About Me</a></li>
        </ul>
        <ul>
          <li><a href='/archive/'>Archive</a></li>
          <li><a href='/tags/'>Tags</a></li>
          <li><a href='/projects/'>Projects</a></li>
        </ul>
      </div>
      <div id='content-wrap'>
        <div class='span-18' id='content'>
          <div id="article">
  <div class="article hentry">
    <h3 class="entry-title"><a href="">Async-Observer with RabbitMQ</a></h3>
    <div class="meta">
      August 08, 2008
      
        |
        Tags:
        
          <a href="/tags.html#ruby">ruby</a>
        
          <a href="/tags.html#rails">rails</a>
        
          <a href="/tags.html#merb">merb</a>
        
      
    </div>
    <div class="entry-content"><p><strong>Update:</strong> This code is stale, I've extracted a gem of it and posted on <a href="http://github.com/jamie/async-observer-amqp">github</a>.</p>

<p><a href="http://github.com/kr/async-observer/tree">Async-observer</a> is great.  Fast, easy to use API, and it Just Works.  The downside is that the backend, Beanstalkd, doesn't support persistent messages in case the server crashes.  I hear it's on the roadmap, though.</p>

<p>However, there's another messaging backend, <a href="http://www.rabbitmq.com/">RabbitMQ</a>, that seems just as easy to get set up, and does support persistent messages.  So, how to get these two bits of tech working together?  Well, if you're hosting your app on <a href="http://code.macournoyer.com/thin/">Thin</a> (or another app server that runs in <a href="http://rubyeventmachine.com/">EventMachine</a>), it's pretty straightforward.</p>

<p>First, install the <a href="http://github.com/tmm1/amqp">amqp</a> ruby library to connect to rabbit, and then add a tiny bit of setup.</p>

<p>In config/environment.rb:</p>

<pre><code>require 'mq'
class BeanstalkPoolImpersonator
  def initialize(opts={})
    @opts = opts
  end

  def connect
    connection = AMQP.connect(@opts)
    @channel = channel = MQ.new(connection)
  end

  def use(queue)
    @queue = MQ::Queue.new(@channel, queue)
  end

  def yput(obj, pri, delay, ttr)
    p [obj, pri, delay, ttr]
    @queue.publish(YAML.dump(obj))
  end

  def last_server
    :last_server_stub
  end

  def subscribe(*args, &amp;blk)
    @queue.subscribe(*args, &amp;blk)
  end
end
</code></pre>

<p>Then, instead of connecting via <code>Beanstalk::Pool.new</code>, do this:</p>

<pre><code>AsyncObserver::Queue.queue = BeanstalkPoolImpersonator.new()
</code></pre>

<p>You can pass an options hash to the <code>new</code> call, providing user, pass, vhost, host, or port as necessary.</p>

<p>Then, in your workers, load up the async_observer worker class, and extend like so:</p>

<pre><code>class RabbitWorker &lt; AsyncObserver::Worker
  def run()
    EM.run do
      AsyncObserver::Queue.queue.connect
      AsyncObserver::Queue.queue.use('1.0')
      AsyncObserver::Queue.queue.subscribe do |headers, msg|
        job = OpenStruct.new(:ybody =&gt; YAML.load(msg), :body =&gt; msg, :stats =&gt; [])
        job.id = headers.properties[:delivery_tag]
        safe_dispatch(job)
      end
    end
  end
end
</code></pre>

<p>Create the new worker the same way you would for the AO::Worker, and you're set:</p>

<pre><code>RabbitWorker.new(binding).run()
</code></pre>

<p>Note: I'm maintaining a <a href="https://github.com/jamie/async-observer">merb port</a> of async-observer on github.</p>

<p>Note 2: This worker is somewhat fragile, if the RabbitMQ server goes down it will just hang forever waiting for more jobs.  I'll need to figure out a solution to that before we move this into production (and I wrap it up in a gem), but I thought I'd get this out and about now.</p>
</div>
  </div>
  
  <div id="disqus_thread"></div>
  <script type="text/javascript" src="http://disqus.com/forums/tracefunc/embed.js"></script>
  <noscript>
    <a href="http://tracefunc.disqus.com/?url=ref">View the discussion thread</a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        </div>
      </div>
      <div class='span-20 last' id='footer'>
        <p>
          &copy; 2006-2008 <span class="author vcard"><span class="fn">Jamie Macey</span></span>
          |
          Original design: <a href="http://www.styleshout.com/templates/preview/CoolWater1-0/index.html">CoolWater</a> by <a href="http://www.styleshout.com/">styleshout</a>
        </p>
      </div>
    </div>

    <script type='text/javascript'>
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type='text/javascript'>
      try {
        var pageTracker = _gat._getTracker("UA-11614297-1");
        pageTracker._setDomainName(".tracefunc.com");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>

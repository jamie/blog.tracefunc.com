<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>set_trace_func</title>
    <meta content='text/html; charset=utf-8' http-equiv='content-type' />
    <link rel="stylesheet" href="/css/blueprint.css" type="text/css"/>
    <!--[if IE]>
      <link rel="stylesheet" href="/css/blueprint-ie.css" type="text/css"/>
    <![endif]-->
    <link rel="stylesheet" href="/css/master.css" type="text/css"/>
    <link href='http://feeds.feedburner.com/set_trace_func' rel='alternate' type='application/atom+xml' />

    <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
    <script type='text/javascript' src="/js/prettify.js"></script>
    <script type='text/javascript' src="/js/blog.js"></script>
  </head>
  <body>
    <div class='container'>
      <div class='span-20 last' id='header'>

        <h1>
          <a href='/'>set_trace_func</a>
        </h1>
        <h2>veni, vidi, didici</h2>
      </div>
      <div class='span-20 last' id='menu'>
        <div id='feedburner'>
          <a href='http://feeds.feedburner.com/set_trace_func'><img alt='RSS Feed' src='http://feeds.feedburner.com/~fc/set_trace_func?bg=0099ff&amp;fg=000000&amp;anim=0' /></a>
        </div>
        <ul style='float: right;'>
          <li><a>&#8203;</a></li>
          <li><a href='/about/'>About Me</a></li>
        </ul>
        <ul>
          <li><a href='/archive/'>Archive</a></li>
          <li><a href='/tags/'>Tags</a></li>
          <li><a href='/projects/'>Projects</a></li>
        </ul>
      </div>
      <div id='content-wrap'>
        <div class='span-18' id='content'>
          <div id="articles">
  
    <div class="article hentry">
      <h3 class="entry-title"><a href="/2009/12/22/migrating-disqus/">Migrating Disqus</a></h3>
      <div class="meta">
        December 22, 2009
        
          |
          Tags:
          
            <a href="/tags.html#blog">blog</a>
          
        
      </div>
      <div class="entry-content"><p>In changing this blog over to jekyll, my urls changed (there's now a trailing slash). Easy enough to tell google about it, just set up redirects, but there's no easy way to tell <a href="http://disqus.com/">Disqus</a> about it so my comments migrate over.</p>

<p>The good news is that it's pretty straightforward using their API, the only bad news is that I can't delete the new threads auto-generated for the new urls, so I'm just moving them out of the way.</p>

<p>I'm using the <a href="http://httparty.rubyforge.org">HTTParty</a> gem to wrap API access, like so:</p>

<pre><code>require 'rubygems'
require 'httparty'
require 'json'

class Disqus
  include HTTParty
  base_uri 'disqus.com'
  format :json

  def initialize(key, version='1.1')
    @key = key
    @version = version
  end

  def auth
    {:user_api_key =&gt; @key, :api_version =&gt; @version}
  end

  def get(action, opts={})
    result = self.class.get("/api/#{action}/", :query =&gt; opts.merge(auth))
    result["message"]
  end

  def post(action, opts={})
    result = self.class.post("/api/#{action}/", :body =&gt; opts.merge(auth).to_params)
    p result
    result["message"]
  end
end
</code></pre>

<p>Do note that I'm adding trailing slashes to the api calls to avoid a redirect. Doesn't matter for the GET, but the redirect on POST was causing issues.</p>

<p>With this in hand, I'm grabbing my forum, looping through the threads, and renaming any that have comments (a whopping 3 of them).</p>

<pre><code>key = "secret" # get yours at http://disqus.com/api/get_my_key/
disqus = Disqus.new(key)

forum = disqus.get(:get_forum_list).first # I just have one
forum_api_key = disqus.get(:get_forum_api_key, :forum_id =&gt; forum["id"])

start = 0 # manual pagination, eww
loop do
  threads = disqus.get(:get_thread_list, :forum_id =&gt; forum["id"], :start =&gt; start)
  break if threads.empty?

  threads.each do |thread|
    posts = disqus.get(:get_thread_posts, :thread_id =&gt; thread["id"])
    next if !posts.empty?

    target_url = thread["url"]+"/"

    # There's another thread in the way...
    if other_thread = disqus.get(
      :get_thread_by_url, 
      :forum_api_key =&gt; forum_api_key,
      :url =&gt; target_url
    )
      # free up the url we want to use
      disqus.post(
        :update_thread,
        :forum_api_key =&gt; forum_api_key,
        :thread_id =&gt; other_thread["id"],
        :url =&gt; target_url + 'old'
      )
    end

    # update thread url
    disqus.post(
      :update_thread,
      :forum_api_key =&gt; forum_api_key,
      :thread_id =&gt; thread["id"],
      :url =&gt; target_url
    )
  end

  start += 25
end
</code></pre>

<p>Et voil√†, old comments are in the right place now.</p>
</div>
    </div>
    <hr />
  
    <div class="article hentry">
      <h3 class="entry-title"><a href="/2009/12/04/jekyll-custom-liquid-tags/">Jekyll: Custom Liquid Tags</a></h3>
      <div class="meta">
        December 04, 2009
        
          |
          Tags:
          
            <a href="/tags.html#blog">blog</a>
          
        
      </div>
      <div class="entry-content"><p>The base install of <a href="http://github.com/mojombo/jekyll">Jekyll</a> at the moment doesn't let you run <em>any</em> arbitrary ruby code. This is so that they can use it for github pages and not need to worry about making a super-secure sandbox just to generate some HTML.</p>

<p>Unfortunately, that means we're out of luck for creating custom liquid filters. The most annoying deficiency for me is tags. The way the default liquid <code>map</code> filter works isn't friendly with @site.tags, so to generate my <a href="/tags/">Tags</a> page I had to do some really crazy stuff with <code>capture</code>:</p>

<pre><code>&lt;div id="articles"&gt;
  &lt;table&gt;
    {% for tag_ in @site.tags %}
      {% capture tag %}{{ tag_ | first }}{% endcapture %}
      &lt;tr&gt;&lt;th&gt;{{ tag }}&lt;/th&gt;
          &lt;th&gt;&lt;a name="{{ tag }}" class="anchor"&gt;&amp;nbsp;&lt;/th&gt;&lt;/tr&gt;
      {% for post in @site.posts %}
        {% if post.tags contains tag %}
          &lt;tr&gt;&lt;td&gt;{{ post.date | date: '%b %e, %Y' }}&lt;/td&gt;
              &lt;td&gt;&lt;a href="{{ post.url }}"&gt;{{ post.title }}&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;
        {% endif %}
      {% endfor %}
    {% endfor %}
  &lt;/table&gt;
&lt;/div&gt;
</code></pre>

<p>Fortunately, it wasn't to hard to make a fork, and in <a href="http://github.com/jamie/jekyll">my fork</a> I added a super simple code loading option. Now, I can add a quick extension in <code>_lib/filters.rb</code> like so:</p>

<pre><code>module Jekyll
  module Filters
    def keys(input)
      input.keys
    end

    def tagged(input, tag)
      input.select{|post| post.tags.include? tag}
    end
  end
end
</code></pre>

<p>Now <code>tags.html</code> looks like this:</p>

<pre><code>&lt;div id="articles"&gt;
  &lt;table&gt;
    {% for tag in @site.tags|keys|sort %}
      &lt;tr&gt;&lt;th&gt;{{ tag }}&lt;/th&gt;
          &lt;th&gt;&lt;a name="{{ tag }}" class="anchor"&gt;&amp;nbsp;&lt;/th&gt;&lt;/tr&gt;
      {% for post in @site.posts|tagged:tag %}
        &lt;tr&gt;&lt;td&gt;{{ post.date | date: '%b %e, %Y' }}&lt;/td&gt;
            &lt;td&gt;&lt;a href="{{ post.url }}"&gt;{{ post.title }}&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;
      {% endfor %}
    {% endfor %}
  &lt;/table&gt;
&lt;/div&gt;
</code></pre>



<p>Similarly, I had some ugly code in my regular <a href="/archive/">archive</a> page to group by year and put headings in:</p>

<pre><code>{% for post in site.posts %}
  {% unless post.next %}
    &lt;tr&gt;&lt;th&gt;{{ post.date | date: '%Y' }}&lt;/th&gt;&lt;th&gt;&amp;nbsp;&lt;/th&gt;&lt;/tr&gt;
  {% else %}
    {% capture year %}{{ post.date | date: '%Y' }}{% endcapture %}
    {% capture nyear %}{{ post.next.date | date: '%Y' }}{% endcapture %}
    {% if year != nyear %}
      &lt;tr&gt;&lt;th&gt;{{ post.date | date: '%Y' }}&lt;/th&gt;&lt;th&gt;&amp;nbsp;&lt;/th&gt;&lt;/tr&gt;
    {% endif %}
  {% endunless %}

  ...
{% endfor %}
</code></pre>

<p>Now, a few extra liquid filters later, it looks like this:</p>

<pre><code>{% for post in site.posts %}
  {% if post.next|last_of_year? %}
    &lt;tr&gt;&lt;th&gt;{{ post.date | date: '%Y' }}&lt;/th&gt;&lt;th&gt;&amp;nbsp;&lt;/th&gt;&lt;/tr&gt;
  {% endif %}

  ...
{% endfor %}
</code></pre>

<p>If you want to get easy extensions in your own project, rather than maintaining Yet Another Jekyll Fork, please vote up <a href="http://github.com/mojombo/jekyll/issues#issue/100">my merge request</a> on github.</p>

<hr />

<p>As a side note, blogging about liquid is a pain. The least pain I've found so far is to use liquid to output the leading open brace for all tags. Looks like garbage in my text editor, but it gets the job done:</p>

<pre><code>{{'{'}}{ post.title }}
</code></pre>

<p>Blogging about blogging about liquid (as above) I leave as an exercise to the reader.</p>
</div>
    </div>
    <hr />
  
    <div class="article hentry">
      <h3 class="entry-title"><a href="/2009/12/01/hoptoad-v2-in-merb/">Hoptoad v2 in Merb</a></h3>
      <div class="meta">
        December 01, 2009
        
          |
          Tags:
          
            <a href="/tags.html#hoptoad">hoptoad</a>
          
            <a href="/tags.html#merb">merb</a>
          
        
      </div>
      <div class="entry-content"><p><a href="http://hoptoadapp.com">Hoptoad</a> has been bugging us for a week or two now to upgrade to v2 of its API, so we did that this week for our project at work. Except we're running Merb, not Rails.</p>

<p>Previously, we've been using Atmos' <a href="http://github.com/atmos/merb_hoptoad_notifier">merb_hoptoad plugin</a>, but it looks like it's been abandoned now in favor of a rack handler, and we needed to hack it a bit to support running multiple sites (with different API keys) off our single codebase. I'm always happy throwing code away, though, so I thought I'd try using the official <a href="http://github.com/thoughtbot/hoptoad_notifier">Hoptoad Notifier plugin</a> and see how hard it is to get working. It wasn't.</p>

<p>First, you probably want to make a gem of the plugin. <a href="http://github.com/thoughtbot/hoptoad_notifier">I forked it</a> a few days back, and just added a jeweller task to create the gem locally. Install in the local gems directory (or system-wide in production if you want to do it the hard way) and add it as a dependency.</p>

<p>Then, to actually use it, just add the following in the right places:</p>

<pre><code># init.rb, in Merb::Bootloader.after_app_loads

HoptoadNotifier.configure do |config|
  config.api_key = '...'
  config.environment_name = Merb.env
  config.project_root = Merb.root
  # See http://github.com/thoughtbot/hoptoad_notifier/ README.rdoc
  # for other config settings. You probably want to think about
  # params_filters and maybe ignore.
end

# application.rb, if you want available manually.
# If you just want it for completely unexpected errors you can stick it in
# exceptions.rb instead

def notify_hoptoad(error=nil)
  error ||= request.exceptions.first

  data = {
    :controller       =&gt; params[:controller],
    :action           =&gt; params[:action],
    :url              =&gt; "#{request.protocol}://#{request.host}#{request.uri}",
    # Looks like hoptoad is filtering these itself, we don't need to worry about it
    # other than configuring what needs to be filtered
    :parameters       =&gt; params.to_hash,
    :session_data     =&gt; session.to_hash,
    :cgi_data         =&gt; request.env.to_hash,
    :environment_vars =&gt; ENV.to_hash.merge(:RAILS_ENV =&gt; Merb.env)
  }

  HoptoadNotifier.notify(error, data)
end

# exceptions.rb, override default error handlers to submit to hoptoad

def internal_server_error
  notify_hoptoad
  render
end

def standard_error
  notify_hoptoad
  render
end    

# other spots you handle exceptions inline, just pass in the exception

begin
 ...
rescue =&gt; e
  notify_hoptoad(e)
end
</code></pre>

<p>It's not exactly as magical as the Rails plugin's auto-including, but it looks like it's getting the job done for us.</p>
</div>
    </div>
    <hr />
  
    <div class="article hentry">
      <h3 class="entry-title"><a href="/2009/11/30/enter-jekyll/">Enter Jekyll</a></h3>
      <div class="meta">
        November 30, 2009
        
          |
          Tags:
          
            <a href="/tags.html#blog">blog</a>
          
        
      </div>
      <div class="entry-content"><p>So I've gone and switched up blogging platforms again. This time, it's <a href="http://github.com/mojombo/jekyll">Jekyll</a>. It's not that I had any problems with <a href="http://github.com/TwP/webby/">webby</a>, just thought I'd try it out. After spending a few hours porting things over (mostly layout and helpers, my posts are already in <a href="http://daringfireball.net/projects/markdown/">markdown</a>) I think I'm going to stick with it.</p>

<p>Being blog-aware is looking like a huge win - if I'm ok with my posts just being recorded by date, rather than date+time, there's a lot less overhead that needs to get done to push a new post up. I have smaller YAML preambles, and the only custom code I'm maintaining is some custom Liquid filters. With less time being spent worrying about the blog software, I might be more successful at the whole blog-writing bit. Maybe.</p>
</div>
    </div>
    <hr />
  
    <div class="article hentry">
      <h3 class="entry-title"><a href="/2009/11/09/heroku/">Heroku</a></h3>
      <div class="meta">
        November 09, 2009
        
          |
          Tags:
          
            <a href="/tags.html#programming">programming</a>
          
        
      </div>
      <div class="entry-content"><p><a href="http://heroku.com">Heroku</a> kicks ass. Very nifty tech running the show, and a really simple interface for deploying - just push up your git repository.</p>

<p>I run this blog through <a href="http://webby.rubyforge.org">webby</a>, which translates some boring old markdown into html so that I can serve it as static files. I like that amount of snappiness.  Heroku wants to run something ruby - rails, merb, or barebones rack.</p>

<p>Turns out, setting up rack to pass static files through is pretty easy, and since I think it just uses send_file behind the scenes, it should be all set up for Heroku to cache it in their Varnish layer, if I ever happen to get a traffic spike.</p>

<p>All you need is a config.ru file like so, and then be sure to include the generated output dir in your git repository:</p>

<pre><code># I don't have file extensions on entry permalinks
Rack::Mime::MIME_TYPES.merge!("" =&gt; "text/html")

class DefaultIndexFile
  def initialize(app, &amp;block)
    @app = app
    yield self if block_given?
  end

  def call(env)
    env['PATH_INFO'] &lt;&lt; 'index.html' if env['PATH_INFO'] =~ /\/$/
    @app.call(env)
  end
end

use DefaultIndexFile

run Rack::File.new('output')
</code></pre>
</div>
    </div>
    <hr />
  
</div>

        </div>
      </div>
      <div class='span-20 last' id='footer'>
        <p>
          &copy; 2006-2008 <span class="author vcard"><span class="fn">Jamie Macey</span></span>
          |
          Original design: <a href="http://www.styleshout.com/templates/preview/CoolWater1-0/index.html">CoolWater</a> by <a href="http://www.styleshout.com/">styleshout</a>
        </p>
      </div>
    </div>

    <script type='text/javascript'>
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type='text/javascript'>
      try {
        var pageTracker = _gat._getTracker("UA-11614297-1");
        pageTracker._setDomainName(".tracefunc.com");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>

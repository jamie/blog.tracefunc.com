<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>set_trace_func ~ Recursiveness</title>
    <meta content='text/html; charset=utf-8' http-equiv='content-type' />
    <link rel="stylesheet" href="/css/blueprint.css" type="text/css"/>
    <!--[if IE]> 
      <link rel="stylesheet" href="/css/blueprint-ie.css" type="text/css"/>
    <![endif]-->
    <link rel="stylesheet" href="/css/master.css" type="text/css"/>
    <link href='http://feeds.feedburner.com/set_trace_func' rel='alternate' type='application/atom+xml' />
    <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
    <script type='text/javascript' src="/js/prettify.js"></script>
    <script type='text/javascript' src="/js/blog.js"></script>
  </head>
  <body>
    <div class='container'>
      <div class='span-20 last' id='header'>
        <h1>
          <a href='/'>set_trace_func</a>
        </h1>
        <h2>veni, vidi, didici</h2>
      </div>
      <div class='span-20 last' id='menu'>
        <div id='feedburner'>
          <a href='http://feeds.feedburner.com/set_trace_func'>
            <img alt='RSS Feed' src='http://feeds.feedburner.com/~fc/set_trace_func?bg=0099ff&amp;fg=000000&amp;anim=0' />
          </a>
        </div>
        <ul style='float: right;'>
          <li>
            <a>&#8203;</a>
          </li>
          <li>
            <a href='/about.html'>About Me</a>
          </li>
        </ul>
        <ul>
          <li>
            <a href='/archive.html'>Archive</a>
          </li>
          <li>
            <a href='/tags.html'>Tags</a>
          </li>
          <li>
            <a href='/projects.html'>Projects</a>
          </li>
        </ul>
      </div>
      <div id='content-wrap'>
        <div class='span-18' id='content'>
          <div id='article'>
            <div class='article hentry'>
              <!-- %h3.entry-title{:rel => 'bookmark'}= link_to_page(@page) -->
              <h3 class='entry-title'><a href="/2006/09/25/recursiveness">Recursiveness</a></h3>
              <div class='entry-content'>
                <p>One of the big things I learned at University was that while "Recursion is a Wonderful Thing" (Thank you, Dr. Roelants), sometimes the performance can really hurt. Those times, it can pay to spend the effort turning that recursive function into a simple loop. Sure, it might not be as clean, or as elegant, or as natural to understand, but we're looking at performance here, right?</p>
                
                <p>Ryan Davis recently <a href="http://blog.zenspider.com/archives/2006/09/recursive_functions_in_rubyinline.html">posted</a> about using RubyInline to optimize a recursive factorial method. He ended with a caveat that sometimes you need to look at other things than just moving the code into C for speed. His idea was to cache the data as it goes along. There are times when that won't help you in the log run (for example, generating a stats graph where caching as you draw helps, but the cached values will be stale the next time you need to do it) but changing it around to iterative can sometimes give you a further speedup.</p>
                
                <pre><code>def fib_iter(n)&#x000A;  return 1 if n &lt; 3  &#x000A;  f = f1 = 1&#x000A;  (2..n).each do&#x000A;    f, f1 = (f+f1), f&#x000A;  end&#x000A;  f&#x000A;end&#x000A;</code></pre>
                
                <p>The benchmarking speaks for itself. (Same parameters as Ryan's benching, 10,000 runs doing fib(15)):</p>
                
                <pre><code>                      user     system      total        real&#x000A;fib-ruby         21.180000   3.640000  24.820000 ( 24.989140)&#x000A;fib-hash-reset    0.510000   0.070000   0.580000 (  0.609976)&#x000A;fib-cache-reset   0.510000   0.050000   0.560000 (  0.570715)&#x000A;fib-iter          0.160000   0.020000   0.180000 (  0.209565)&#x000A;fib-hash          0.020000   0.000000   0.020000 (  0.034616)&#x000A;fib-cached        0.020000   0.010000   0.030000 (  0.035222)&#x000A;</code></pre>
                
                <p>Benchmarks for fib-ruby and fib-cached come from Ryan's post. fib-iter and fib-hash are mine.</p>
                
                <p>The two "-reset" methods are indicative of times when global caching won't help you, which is still a significant speedup over the uncached versions. (For fib(15), uncached will need ~610 method calls, compared to ~15) The iterative method is about 1/3 their speed, but when you can globally cache you can get huge gains - if I increased the number of runs in the benchmark, the discrepancy between fib-iter and fib-cached would increase even more.</p>
                
                <p>So once again, it seems that there's a different best solution for two different problems.</p>
                
                <p>And the fib-hash benchmark? It's not significantly faster than Ryan's fib-cached method, but it bumps the fib logic from a method that uses a hash into the hash itself. It's a neat trick I picked up a while ago, but probably too ugly to make significant use of unless your benchmarking tells you otherwise - it's really hard to read at first glance:</p>
                
                <pre><code>def hashfib(n)&#x000A;  return 1 if n &lt;= 1&#x000A;  h = Hash.new{|h,k| h[k] = h[k-1] + h[k-2] }&#x000A;  h[1] = 1&#x000A;  h[2] = 1&#x000A;  h[n]&#x000A;end&#x000A;</code></pre>
                
                <p>The cached version uses @@h instead of h, and ||=s it.</p>
              </div>
              <div class='footer'>
                <abbr class="published date" title="2006-09-25T12:02:00-04:00">Sep 25, 2006 at 12:02</abbr>
                &nbsp; | &nbsp; tagged:
                <a href="/tags.html#programming">programming</a>
                <a href="/tags.html#ruby">ruby</a>
              </div>
            </div>
            <div id='disqus_thread'></div>
            <script src='http://disqus.com/forums/tracefunc/embed.js' type='text/javascript'></script>
            <noscript>
              <a href='http://tracefunc.disqus.com/?url=ref'>View the discussion thread.</a>
            </noscript>
            <a class='dsq-brlink' href='http://disqus.com'>blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        </div>
      </div>
      <div class='span-20 last' id='footer'>
        <p>
          &copy; 2006-2008 <span class="author vcard"><span class="fn">Jamie Macey</span></span>
          |
          Original design: <a href="http://www.styleshout.com/templates/preview/CoolWater1-0/index.html">CoolWater</a> by <a href="http://www.styleshout.com/">styleshout</a>
        </p>
      </div>
    </div>
  </body>
</html>
